<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>æ‹¼å• - å•†å“è¯¦æƒ…é¡µ</title>
    <link href="css/index.css" rel="stylesheet">

</head>
<body>
<!-- è½®æ’­å›¾ -->
<div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="./images/sku-13811216-01.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-02.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-03.png"></div>
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="top-navbar">
    <div class="navbar-content">
        <h2 class="navbar-title">æ‹¼å•äº¤æ˜“ç³»ç»Ÿ</h2>
        <button class="logout-btn" id="logout-btn">
            <span class="logout-icon">ğŸšª</span>
            åˆ‡æ¢è´¦å·
        </button>
    </div>
</div>

<!-- å•†å“ä¿¡æ¯ -->
<div class="product-info">
    <h1 class="product-title">æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</h1>
    <span class="promotion-tag">å¤§ä¿ƒä¼˜æƒ </span>
    <span class="promotion-text"></span> <!-- åŠ¨æ€å¡«å……ä¿ƒé”€æ–‡æœ¬ -->
</div>

<!-- æ‹¼å•åˆ—è¡¨å®¹å™¨ -->
<div class="group-list">
    <!-- åŠ¨æ€ç”Ÿæˆæ‹¼å•åˆ—è¡¨ -->
</div>

<!-- ç©ºç™½åŒºåŸŸ -->
<div class="area"></div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div class="action-bar">
    <button class="action-btn buy-alone"></button>
    <button class="action-btn group-buy"></button>
    <button class="action-btn order-list-btn" onclick="window.location.href='order-list.html'">æˆ‘çš„è®¢å•</button>
    <button class="action-btn test-callback-btn" onclick="window.location.href='test-callback.html'">æ‰‹åŠ¨å›è°ƒ</button>
</div>

<script src="js/common.js"></script>
<script src="js/index.js"></script>
<script>
    // æ–°å¢æ”¯ä»˜ç¡®è®¤å‡½æ•°
    function showPaymentConfirm(price) {
        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.className = 'payment-overlay';

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modal = document.createElement('div');
        modal.className = 'payment-modal';
        modal.innerHTML = `
        <h3>æ”¯ä»˜ç¡®è®¤</h3>
        <p>å•†å“é‡‘é¢ï¼šï¿¥${price}</p>
        <p>ä¹°å®¶è´¦å·ï¼š<span class="buyer-account">
            <span class="account-text">bcywss3672@sandbox.com</span>
            <button class="copy-btn" data-copy="bcywss3672@sandbox.com" title="å¤åˆ¶è´¦å·">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="m5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </span></p>
        <p>ç™»å½•å¯†ç ï¼š111111</p>
        <p>æ”¯ä»˜å¯†ç ï¼š111111</p>
        <p>ç‚¹å‡»â€œç¡®è®¤æ”¯ä»˜â€åå°†è·³è½¬è‡³æ”¯ä»˜é¡µé¢ï¼Œæ”¯ä»˜å®Œæˆåä¼šè‡ªåŠ¨è¿”å›å¹³å°ã€‚</p>
        <div class="modal-buttons">
            <button class="confirm-btn">ç¡®è®¤æ”¯ä»˜</button>
            <button class="cancel-btn">å–æ¶ˆæ”¯ä»˜</button>
        </div>
    `;

        // ç¡®è®¤æ”¯ä»˜å¤„ç†
        modal.querySelector('.confirm-btn').addEventListener('click', function () {
            const form = document.querySelector('form');
            if (form) form.submit();
            overlay.remove();
        });

        // å–æ¶ˆæ”¯ä»˜å¤„ç†
        modal.querySelector('.cancel-btn').addEventListener('click', function () {
            document.querySelectorAll('form').forEach(form => form.remove());
            overlay.remove();
        });

        // æ·»åŠ å¤åˆ¶åŠŸèƒ½
        modal.querySelector('.copy-btn').addEventListener('click', function () {
            const textToCopy = this.getAttribute('data-copy');
            const button = this;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                // âœ… æ”¯æŒ clipboard API
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess(button);
                }).catch(err => {
                    console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
                    fallbackCopy(textToCopy, button);
                });
            } else {
                // âŒ å…¼å®¹å¤„ç†
                fallbackCopy(textToCopy, button);
            }
        });

        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';  // é˜²æ­¢æ»šåŠ¨
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬');
                }
            } catch (err) {
                console.error('execCommand å¤åˆ¶å¤±è´¥', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬');
            }
            document.body.removeChild(textarea);
        }

        function showCopySuccess(button) {
            const originalHtml = button.innerHTML;
            button.innerHTML = `âœ”ï¸ å·²å¤åˆ¶`;
            button.style.color = '#48bb78';
            setTimeout(() => {
                button.innerHTML = originalHtml;
                button.style.color = '';
            }, 1500);
        }

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // ä½¿ç”¨å…¬å…±é…ç½®
        var sPayMallUrl = AppConfig.sPayMallUrl;
        var groupBuyMarketUrl = AppConfig.groupBuyMarketUrl;
        var goodsId = AppConfig.goodsId;

        // é€€å‡ºç™»å½•åŠŸèƒ½
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            // æ¸…é™¤loginToken cookie
            document.cookie = 'loginToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
            window.location.href = 'login.html';
        });

        // è·å–ç”¨æˆ·ä¿¡æ¯
        var userId = AppUtils.getCurrentUserId();
        if (!userId) {
            return;
        }

        // è¯·æ±‚æ¥å£æ•°æ®
        fetch(groupBuyMarketUrl + '/api/v1/gbm/index/query_group_buy_market_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                source: "s01",
                channel: "c01",
                goodsId: goodsId
            })
        })
            .then(response => response.json())
            .then(res => {
                if (res.code !== '0000') {
                    const errorMessage = res.info || res.message || 'è·å–å•†å“ä¿¡æ¯å¤±è´¥';
                    AppUtils.showToast(errorMessage, 'error');
                    return;
                }

                const {activityId, goods, teamList, teamStatistic} = res.data;
                const groupList = document.querySelector('.group-list');
                const promotionText = document.querySelector('.promotion-text');

                // æ›´æ–°ä¿ƒé”€ä¿¡æ¯
                promotionText.textContent = `ç›´é™ Â¥${goods.deductionPrice.toFixed(0)}ï¼Œ${teamStatistic.allTeamUserCount}äººåœ¨æŠ¢ï¼Œå‚ä¸é©¬ä¸ŠæŠ¢åˆ°`;

                // æ¸…ç©ºå¹¶ç”Ÿæˆæ‹¼å•åˆ—è¡¨
                groupList.innerHTML = '';

                if (teamList.length === 0) {
                    groupList.innerHTML = `
                <div class="group-item empty-tips">
                    <div class="tips-content">
                        æš‚æ— æ‹¼å•è®°å½•ï¼Œå¼€å§‹æ‹¼å•å§ï¼ğŸ‰
                    </div>
                </div>
            `;
                } else {
                    teamList.forEach(team => {
                        const remaining = team.targetCount - team.lockCount;
                        const currentUserId = AppUtils.getCurrentUserId();
                        const isCurrentUser = team.userId === currentUserId;
                        
                        // æ„å»ºç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯å½“å‰ç”¨æˆ·åˆ™æ·»åŠ "æˆ‘"æ ‡ç­¾
                        const userDisplay = isCurrentUser 
                            ? `${obfuscateUserId(team.userId)} <span class="me-tag">æˆ‘</span>`
                            : obfuscateUserId(team.userId);
                        
                        // æ„å»º"å‚ä¸æ‹¼å•"æŒ‰é’®ï¼Œåªæœ‰éå½“å‰ç”¨æˆ·æ‰æ˜¾ç¤º
                        const joinButton = isCurrentUser 
                            ? '' 
                            : '<button class="group-btn" data-price="' + goods.payPrice.toFixed(0) + '">å‚ä¸æ‹¼å•</button>';

                        groupList.innerHTML += `
                    <div class="group-item">
                        <div>
                            <div class="user-info" data-teamId="${team.teamId}" data-activityId="${team.activityId}">${userDisplay}</div>
                            <div class="group-status">
                                <span>ç»„é˜Ÿä»…å‰©${remaining}äººï¼Œæ‹¼å•å³å°†ç»“æŸ</span>
                                <span class="countdown">${team.validTimeCountdown}</span>
                            </div>
                        </div>
                        <div class="right">
                            ${joinButton}
                        </div>
                    </div>
                `;
                    });
                }

                // æ›´æ–°åº•éƒ¨æŒ‰é’®
                const buyAloneBtn = document.querySelector('.buy-alone');
                const groupBuyBtn = document.querySelector('.group-buy');
                buyAloneBtn.textContent = `å•ç‹¬è´­ä¹°(ï¿¥${goods.originalPrice.toFixed(0)})`;
                buyAloneBtn.dataset.price = goods.originalPrice;
                groupBuyBtn.textContent = `æ‹¼å•è´­ä¹°(ï¿¥${goods.payPrice.toFixed(0)})`;
                groupBuyBtn.dataset.price = goods.payPrice;

                // ç»‘å®šæ”¯ä»˜äº‹ä»¶[æ‹¼å•è´­ä¹°]
                document.querySelectorAll('.group-btn, .group-buy').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const button = this;
                        const price = button.dataset.price;

                        // è·å–æ‹¼å•ID
                        let teamId = null;
                        if (this.classList.contains('group-btn')) {
                            const groupItem = this.closest('.group-item');
                            const userInfo = groupItem.querySelector('.user-info');
                            teamId = userInfo.dataset.teamid;
                        }

                        var url = sPayMallUrl + '/api/v1/alipay/create_pay_order';

                        var requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            teamId: teamId,
                            activityId: activityId,
                            marketType: 1
                        };

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody) // å°†è¯·æ±‚ä½“è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                        })
                            .then(response => response.json()) // è§£æJSONæ ¼å¼çš„å“åº”
                            .then(json => {
                                if (json.code === "0000") { // å‡è®¾æˆåŠŸçš„codeæ˜¯"0000"
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    const errorMessage = json.info || json.message || 'åˆ›å»ºæ‹¼å•è®¢å•å¤±è´¥';
                                    AppUtils.showToast(errorMessage, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                AppUtils.showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                            });

                    });
                });

                // ç»‘å®šæ”¯ä»˜äº‹ä»¶[å•ç‹¬è´­ä¹°]
                document.querySelectorAll('.buy-alone').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const button = this;
                        const price = button.dataset.price;

                        var requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            marketType: 0
                        };

                        fetch(sPayMallUrl + '/api/v1/alipay/create_pay_order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody) // å°†è¯·æ±‚ä½“è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                        })
                            .then(response => response.json()) // è§£æJSONæ ¼å¼çš„å“åº”
                            .then(json => {
                                if (json.code === "0000") { // å‡è®¾æˆåŠŸçš„codeæ˜¯"0000"
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    const errorMessage = json.info || json.message || 'åˆ›å»ºå•ç‹¬è´­ä¹°è®¢å•å¤±è´¥';
                                    AppUtils.showToast(errorMessage, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                AppUtils.showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                            });
                    });
                });

                // å¯åŠ¨å€’è®¡æ—¶
                document.querySelectorAll('.countdown').forEach(el => {
                    new Countdown(el, el.textContent);
                });

            });

    });
</script>

</body>
</html>